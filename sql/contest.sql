-- Aggregate Contest ------------------------------------

CREATE TABLE CONTEST(
  ID BIGSERIAL PRIMARY KEY,
  CONTEST_ID TEXT UNIQUE NOT NULL,
  TITLE TEXT,
  START_TIME INTEGER ,
  END_TIME INTEGER ,
  TIMEZONE TEXT,
  PLACE TEXT,
  COUNTRY TEXT,
  HQ_LAT REAL,
  HQ_LON REAL,
  RETRIEVE_ID TEXT,

  UNIQUE (TITLE, START_TIME, END_TIME, COUNTRY)
);

CREATE TABLE PARTICIPANT(
  ID BIGINT REFERENCES CONTEST(ID) ON DELETE CASCADE,
  PARTICIPANT_ID TEXT ,
  ROLE TEXT NOT NULL, -- paraglider, winddummy, staff, organizer
  -- for paragliders
  GLIDER TEXT,
  CONTEST_NUMBER TEXT ,
  -- for staff, organizer
  DESCRIPTION TEXT,
  TYPE TEXT , --staff's type
  PHONE TEXT ,
  NAME TEXT ,
  EMAIL TEXT,
  COUNTRY TEXT,
  TITLE TEXT, -- for staff

  PRIMARY KEY (ID, PARTICIPANT_ID)
);

CREATE UNIQUE INDEX UNIQUE_CONTEST_NUMBER ON PARTICIPANT (ID, CONTEST_NUMBER) WHERE ROLE='PARAGLIDER';

CREATE TABLE TASK (
  ID BIGINT REFERENCES CONTEST(ID) ON DELETE CASCADE,
  TASK_ID TEXT UNIQUE NOT NULL,
  TYPE BIGINT REFERENCES RACE_TYPE(ID),
  TITLE TEXT NOT NULL,
  WINDOW_OPEN INTEGER NOT NULL,
  DEADLINE INTEGER NOT NULL,
  WINDOW_CLOSE INTEGER ,
  START_TIME INTEGER ,
  CHECKPOINTS TEXT NOT NULL,
  BEARING SMALLINT ,
  GATES_NUMBER SMALLINT ,
  GATES_INTERVAL SMALLINT ,

  PRIMARY KEY (ID, TASK_ID),
  UNIQUE (ID, TITLE)
);

-- Insert Contest
INSERT INTO CONTEST(
  TITLE, START_TIME, END_TIME, TIMEZONE, PLACE, COUNTRY, HQ_LAT, HQ_LON,
  RETRIEVE_ID, CONTEST_ID)
  VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
RETURNING ID;

-- Select Contest
SELECT
  ID, TITLE, START_TIME, END_TIME, PLACE, COUNTRY, HQ_LAT, HQ_LON, TIMEZONE,
  CONTEST_ID, RETRIEVE_ID
FROM CONTEST WHERE CONTEST_ID=%s;

-- Select all_contest
SELECT
  CONTEST_ID, ID, CONTEST_ID, TITLE, START_TIME, END_TIME, TIMEZONE, PLACE,
  COUNTRY, HQ_LAT, HQ_LON
FROM
  CONTEST;

-- Insert participant
INSERT INTO PARTICIPANT VALUES (
 %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s);

-- Select participants
SELECT * FROM PARTICIPANT WHERE ID=%s;

-- Insert task
INSERT INTO TASK VALUES (
    %s, %s, (SELECT ID FROM RACE_TYPE WHERE TYPE=%s), %s, %s, %s, %s, %s,
    %s, %s, %s, %s);

-- Select tasks
SELECT ID, TASK_ID, (SELECT TYPE FROM RACE_TYPE WHERE ID=TASK.TYPE), TITLE,
        WINDOW_OPEN, DEADLINE, WINDOW_CLOSE, START_TIME, CHECKPOINTS,
        BEARING, GATES_NUMBER, GATES_INTERVAL
FROM TASK WHERE ID=%s;

-- Update contest
UPDATE CONTEST SET (
  TITLE, START_TIME, END_TIME, TIMEZONE, PLACE, COUNTRY, HQ_LAT, HQ_LON,
  RETRIEVE_ID)
= (%s, %s, %s, %s, %s, %s, %s, %s, %s)
WHERE CONTEST_ID=%s;

